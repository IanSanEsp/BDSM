<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Test API Marcadores</title>
  <style>
    body { font-family: system-ui, Arial, sans-serif; margin: 20px; }
    input, button, select { margin: 4px 0; padding: 6px; }
    .row { margin-bottom: 10px; }
    .ok { color: #2E7D32; }
    .err { color: #C62828; }
    pre { background: #f5f5f5; padding: 10px; border-radius: 6px; overflow: auto; }
  </style>
</head>
<body>
  <h1>Prueba rápida de /api/salon-markers</h1>
  <p>Usa el token guardado en <code>localStorage.token</code> (inicia sesión en Admin desde <code>btzLogin.html</code> antes de probar).</p>

  <div class="row">
    <label>API Base:</label>
    <input id="apiBase" style="width: 360px;" />
  </div>

  <div class="row">
    <label>Token:</label>
    <input id="token" style="width: 480px;" />
    <button id="btnLoadToken">Cargar token de localStorage</button>
  </div>

  <hr/>

  <div class="row">
    <label>Piso:</label>
    <select id="piso">
      <option value="1">1</option>
      <option value="2">2</option>
      <option value="3">3</option>
    </select>
  </div>
  <div class="row">
    <label>ID Salón:</label>
    <input id="idSalon" placeholder="Ej: A101" />
  </div>
  <div class="row">
    <label>X:</label>
    <input id="posX" type="number" step="0.01" value="10.00" />
    <label>Y:</label>
    <input id="posY" type="number" step="0.01" value="20.00" />
  </div>
  <div class="row">
    <button id="btnPut">PUT (guardar)</button>
    <button id="btnGet">GET (listar por piso)</button>
    <button id="btnDel">DELETE (borrar)</button>
  </div>

  <h3>Resultado</h3>
  <div id="status"></div>
  <pre id="output"></pre>

<script>
const API_DEFAULT = (location.hostname === 'localhost' || location.hostname === '127.0.0.1')
  ? 'http://localhost:3000'
  : 'https://bdsm-production-0032.up.railway.app';

const apiBaseEl = document.getElementById('apiBase');
const tokenEl = document.getElementById('token');
const statusEl = document.getElementById('status');
const outputEl = document.getElementById('output');

apiBaseEl.value = API_DEFAULT;

function show(type, msg) {
  statusEl.className = type === 'ok' ? 'ok' : 'err';
  statusEl.textContent = msg;
}
function print(obj) {
  outputEl.textContent = (typeof obj === 'string') ? obj : JSON.stringify(obj, null, 2);
}

function getHeaders() {
  const t = (tokenEl.value || '').trim();
  return t ? { Authorization: `Bearer ${t}` } : {};
}

// Cargar token de localStorage
btnLoadToken.addEventListener('click', () => {
  try { tokenEl.value = localStorage.getItem('token') || ''; show('ok', 'Token cargado de localStorage'); }
  catch { show('err', 'No se pudo cargar el token'); }
});

btnPut.addEventListener('click', async () => {
  const api = apiBaseEl.value.trim();
  const piso = document.getElementById('piso').value;
  const idSalon = document.getElementById('idSalon').value.trim();
  const x = parseFloat(document.getElementById('posX').value);
  const y = parseFloat(document.getElementById('posY').value);
  if (!idSalon) { show('err', 'Falta ID de salón'); return; }
  try {
    const res = await fetch(`${api}/api/salon-markers`, {
      method: 'PUT',
      headers: { 'Content-Type': 'application/json', ...getHeaders() },
      body: JSON.stringify({ piso: String(piso), id_salon: String(idSalon), x: Number(x), y: Number(y) })
    });
    const txt = await res.text();
    if (!res.ok) { show('err', `HTTP ${res.status}`); print(txt); return; }
    show('ok', 'Marcador guardado'); print(txt);
  } catch (e) {
    show('err', e.message || 'Error'); print(e);
  }
});

btnGet.addEventListener('click', async () => {
  const api = apiBaseEl.value.trim();
  const piso = document.getElementById('piso').value;
  try {
    const res = await fetch(`${api}/api/salon-markers?piso=${encodeURIComponent(piso)}`, { headers: getHeaders() });
    const txt = await res.text();
    if (!res.ok) { show('err', `HTTP ${res.status}`); print(txt); return; }
    show('ok', 'Listado'); print(txt);
  } catch (e) {
    show('err', e.message || 'Error'); print(e);
  }
});

btnDel.addEventListener('click', async () => {
  const api = apiBaseEl.value.trim();
  const piso = document.getElementById('piso').value;
  const idSalon = document.getElementById('idSalon').value.trim();
  if (!idSalon) { show('err', 'Falta ID de salón'); return; }
  try {
    const res = await fetch(`${api}/api/salon-markers/${encodeURIComponent(piso)}/${encodeURIComponent(idSalon)}`, {
      method: 'DELETE', headers: getHeaders()
    });
    const txt = await res.text();
    if (!res.ok) { show('err', `HTTP ${res.status}`); print(txt); return; }
    show('ok', 'Marcador borrado'); print(txt);
  } catch (e) {
    show('err', e.message || 'Error'); print(e);
  }
});
</script>
</body>
</html>
